---
title: "享元模式 (Flyweight)"
date: 2021-12-12T16:29:53+08:00
draft: false
tags: [设计模式]
categories: [笔记] 
---

# 定义

它用于通过尽可能多地与相似对象共享来最小化内存使用或计算开销。

享元模式从对象中剥离出不发生改变且多个实例需要的重复数据，独立出一个享元，使多个对象共享，从而节省内存以及减少对象数量。

**何时使用**

系统中有大量对象。 

些对象消耗大量内存。 

这些对象的状态大部分可以外部化。 

对象可以按照内蕴状态分为很多组，当把外蕴对象从对象中剔除出来时，每一组对象都可以用一个对象来代替。

系统不依赖于这些对象身份，这些对象是不可分辨的。

# 样例

一般会用map来存储。

```go
package flyweight

import "fmt"

type ImageFlyweightFactory struct {
	maps map[string]*ImageFlyweight
}

var imageFactory *ImageFlyweightFactory

func GetImageFlyweightFactory() *ImageFlyweightFactory {
	if imageFactory == nil {
		imageFactory = &ImageFlyweightFactory{
			maps: make(map[string]*ImageFlyweight),
		}
	}
	return imageFactory
}

func (f *ImageFlyweightFactory) Get(filename string) *ImageFlyweight {
	image := f.maps[filename]
	if image == nil {
		image = NewImageFlyweight(filename)
		f.maps[filename] = image
	}

	return image
}

type ImageFlyweight struct {
	data string
}

func NewImageFlyweight(filename string) *ImageFlyweight {
	// Load image file
	data := fmt.Sprintf("image data %s", filename)
	return &ImageFlyweight{
		data: data,
	}
}

func (i *ImageFlyweight) Data() string {
	return i.data
}

type ImageViewer struct {
	*ImageFlyweight
}

func NewImageViewer(filename string) *ImageViewer {
	image := GetImageFlyweightFactory().Get(filename)
	return &ImageViewer{
		ImageFlyweight: image,
	}
}

func (i *ImageViewer) Display() {
	fmt.Printf("Display: %s\n", i.Data())
}
```

测试

```go
package flyweight

import "testing"

func TestFlyweight(t *testing.T) {
	viewer1 := NewImageViewer("image1.png")
	viewer1.Display()
	viewer2 := NewImageViewer("image1.png")
	viewer2.Display()

	if viewer1.ImageFlyweight != viewer2.ImageFlyweight {
		t.Fail()
	}
}
```

# 参考文献

1. https://github.com/kamranahmedse/design-patterns-for-humans
2. https://github.com/senghoo/golang-design-pattern

